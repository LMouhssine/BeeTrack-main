<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <title>Gestion des Alertes - BeeTrack</title>
    
    <!-- Le CSS principal est déjà inclus par layout.html -->
    
    <!-- Styles spécifiques à la page -->
    <style>
        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            font-family: var(--font-mono);
        }
        .log-entry { display: flex; gap: var(--space-2); margin-bottom: var(--space-2); font-size: 13px; line-height: 1.4; }
        .log-entry:last-child { margin-bottom: 0; }
        .log-time { color: var(--gray-500); min-width: 80px; flex-shrink: 0; }
        .log-message { color: var(--gray-900); }
        .log-entry.success .log-message { color: var(--success); }
        .log-entry.error .log-message { color: var(--error); }
        .border-success { border-color: var(--success) !important; }
        .border-warning { border-color: var(--warning) !important; }
        .w-8 { width: 2rem; } .h-8 { height: 2rem; }
        .space-y-2 > * + * { margin-top: var(--space-2); }
        .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .lg\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .md\:grid-cols-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="content-section">
            <!-- En-tête de page organisé -->
            <div class="page-header">
                <div>
                    <h1 class="page-title" th:text="${pageTitle ?: 'Gestion des Alertes'}">Gestion des Alertes</h1>
                    <p class="page-subtitle" th:text="${pageSubtitle ?: 'Gestion de vos ruches connectées'}">Gestion de vos ruches connectées</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="btn btn-secondary">
                        <i data-lucide="wifi" aria-hidden="true"></i>
                        <span class="text-sm">Connecté</span>
                    </div>
                    <div class="btn btn-secondary">
                        <i data-lucide="bell" aria-hidden="true"></i>
                        <span class="text-sm">Alertes</span>
                    </div>
                    <div class="btn btn-secondary">
                        <i data-lucide="user" aria-hidden="true"></i>
                        <span class="text-sm" th:text="${#authentication != null ? #authentication.name : 'Utilisateur'}">Utilisateur</span>
                        <span class="text-sm text-gray-600" style="margin-left:6px;" th:text="${userRole ?: 'Apiculteur'}">Apiculteur</span>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Statut de Surveillance
                    </h3>
                </div>
                <div class="card-body">
                    <div id="statut-surveillance" class="loading">
                        <div class="spinner"></div>
                        <span>Chargement...</span>
                    </div>
                </div>
            </div>

            <!-- Test Alert -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        Test d'Alerte
                    </h3>
                </div>
                <div class="card-body">
                    <form id="test-alerte-form">
                        <div class="form-group">
                            <label for="ruche-id" class="form-label">ID de la Ruche</label>
                            <input type="text" id="ruche-id" name="rucheId" class="form-control" placeholder="Ex: ruche_001" required>
                        </div>
                        <button type="submit" class="btn" style="background: var(--warning); color: var(--white);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                            Tester l'Alerte
                        </button>
                    </form>
                </div>
            </div>

            <!-- Active Inhibitions -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Inhibitions Actives
                    </h3>
                </div>
                <div class="card-body">
                    <div id="inhibitions-list" class="loading">
                        <div class="spinner"></div>
                        <span>Chargement...</span>
                    </div>
                </div>
            </div>

            <!-- Alert Logs -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                        Logs d'Alertes
                    </h3>
                </div>
                <div class="card-body">
                    <div id="alertes-logs" class="logs-container">
                        <div class="log-entry">
                            <span class="log-time">[Système]</span>
                            <span class="log-message">Système d'alertes initialisé</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts spécifiques à la page -->
    <th:block layout:fragment="scripts">
    <script>
        let statutInterval;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            rafraichirStatut();
            chargerInhibitions();
            
            statutInterval = setInterval(() => {
                rafraichirStatut();
                chargerInhibitions();
            }, 30000);
        });

        // Refresh surveillance status
        async function rafraichirStatut() {
            const container = document.getElementById('statut-surveillance');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Chargement...</span></div>';
            
            try {
                const response = await fetch('/api/alertes/statut', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    afficherStatut(data);
                } else {
                    throw new Error('Erreur lors de la récupération du statut');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span>Erreur: ${error.message}</span>
                    </div>
                `;
            }
        }

        // Display status
        function afficherStatut(data) {
            const container = document.getElementById('statut-surveillance');
            
            container.innerHTML = `
                <div class="grid grid-cols-2" style="gap: var(--space-6);">
                    <div class="stat-card ${data.surveillanceActive ? 'border-success' : 'border-warning'}">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value ${data.surveillanceActive ? 'text-success' : 'text-warning'}">
                                    ${data.surveillanceActive ? 'Active' : 'Inactive'}
                                </div>
                                <div class="stat-label">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Surveillance
                                </div>
                            </div>
                            <div class="stat-icon ${data.surveillanceActive ? 'bg-success' : 'bg-warning'}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value">${data.nombreRuchesSurveillees || 0}</div>
                                <div class="stat-label">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                        <polyline points="2,17 12,22 22,17"/>
                                        <polyline points="2,12 12,17 22,12"/>
                                    </svg>
                                    Ruches surveillées
                                </div>
                            </div>
                            <div class="stat-icon bg-primary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                    <polyline points="2,17 12,22 22,17"/>
                                    <polyline points="2,12 12,17 22,12"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${data.ruchesSurveillees && data.ruchesSurveillees.length > 0 ? `
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold mb-3">Ruches surveillées:</h4>
                        <div class="flex flex-wrap gap-2">
                            ${Array.from(data.ruchesSurveillees).map(rucheId => `
                                <span class="badge badge-secondary">${rucheId}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Load inhibitions
        async function chargerInhibitions() {
            const container = document.getElementById('inhibitions-list');
            
            try {
                const response = await fetch('/api/alertes/inhibition/actives', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    afficherInhibitions(data);
                } else {
                    throw new Error('Erreur lors de la récupération des inhibitions');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span>Erreur: ${error.message}</span>
                    </div>
                `;
            }
        }

        // Display inhibitions
        function afficherInhibitions(inhibitions) {
            const container = document.getElementById('inhibitions-list');
            
            if (Object.keys(inhibitions).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                <path d="M9 12l2 2 4-4"/>
                            </svg>
                        </div>
                        <h3 class="empty-title">Aucune inhibition active</h3>
                        <p class="empty-description">Toutes les alertes sont actives</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3" style="gap: var(--space-4);">
                    ${Object.entries(inhibitions).map(([rucheId, info]) => `
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 bg-warning text-white rounded-lg flex items-center justify-center">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-semibold">${rucheId}</div>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Durée:</span>
                                    <span class="font-medium">${info.dureeHeures}h</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Fin:</span>
                                    <span class="font-medium">${new Date(info.finInhibition).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Test alert form
        document.getElementById('test-alerte-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rucheId = document.getElementById('ruche-id').value;
            const button = this.querySelector('button[type="submit"]');
            const originalHTML = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div><span>Envoi...</span>';
            
            try {
                const response = await fetch('/api/alertes/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rucheId: rucheId })
                });

                if (response.ok) {
                    ajouterLog('success', `Test d'alerte envoyé pour ${rucheId}`);
                    document.getElementById('ruche-id').value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors du test');
                }
            } catch (error) {
                ajouterLog('error', `Erreur: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        });

        // Add log entry
        function ajouterLog(type, message) {
            const logsContainer = document.getElementById('alertes-logs');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-message">${message}</span>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (statutInterval) {
                clearInterval(statutInterval);
            }
        });
    </script>
    </th:block>
</body>
</html>