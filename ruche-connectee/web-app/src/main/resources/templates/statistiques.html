<!DOCTYPE html>
<html lang="fr" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Statistiques - BeeTrack</title>
</head>

<body>
    <div layout:fragment="content" class="statistiques-container">
        <!-- En-tête de la page -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i data-lucide="bar-chart-3" class="me-2"></i>
                    Statistiques et analyses
                </h1>
                <div class="header-actions">
                    <select id="periodSelector" class="form-control">
                        <option value="7d">7 derniers jours</option>
                        <option value="30d" selected>30 derniers jours</option>
                        <option value="3m">3 derniers mois</option>
                        <option value="1y">1 année</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exporterRapport()">
                        <i data-lucide="download" class="me-2"></i>
                        Exporter
                    </button>
                </div>
            </div>
        </div>

        <!-- Vue d'ensemble -->
        <div class="overview-section">
            <h2 class="section-title">Vue d'ensemble</h2>
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-header">
                        <div>
                            <h3 class="stat-value" th:text="${totalRuches ?: 0}">12</h3>
                            <p class="stat-label">Ruches totales</p>
                        </div>
                        <div class="stat-icon bg-amber-500">
                            <i data-lucide="hexagon"></i>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator positive">
                            <i data-lucide="trending-up"></i>
                            +2 ce mois
                        </span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3 class="stat-value text-green-600" th:text="${productionMielEstimee ?: '0'}">125</h3>
                            <p class="stat-label">kg de miel (estimé)</p>
                        </div>
                        <div class="stat-icon bg-green-500">
                            <i data-lucide="droplets"></i>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator positive">
                            <i data-lucide="trending-up"></i>
                            +15% vs l'an dernier
                        </span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3 class="stat-value text-blue-600">98.2%</h3>
                            <p class="stat-label">Taux de disponibilité</p>
                        </div>
                        <div class="stat-icon bg-blue-500">
                            <i data-lucide="activity"></i>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator positive">
                            <i data-lucide="trending-up"></i>
                            +0.5% ce mois
                        </span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <h3 class="stat-value text-purple-600" th:text="${alertesResolues ?: 0}">47</h3>
                            <p class="stat-label">Alertes résolues</p>
                        </div>
                        <div class="stat-icon bg-purple-500">
                            <i data-lucide="check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator">
                            <i data-lucide="minus"></i>
                            Stable
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphiques principaux -->
        <div class="charts-section">
            <div class="charts-grid">
                <!-- Évolution de la production -->
                <div class="chart-card large">
                    <div class="chart-header">
                        <h3>
                            <i data-lucide="trending-up" class="me-2"></i>
                            Évolution de la production de miel
                        </h3>
                        <div class="chart-controls">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-secondary active" data-period="mois">Mois</button>
                                <button type="button" class="btn btn-sm btn-secondary" data-period="trimestre">Trimestre</button>
                                <button type="button" class="btn btn-sm btn-secondary" data-period="annee">Année</button>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="productionChart"></canvas>
                    </div>
                </div>

                <!-- Température moyenne -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>
                            <i data-lucide="thermometer" class="me-2"></i>
                            Température moyenne
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>

                <!-- Humidité moyenne -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>
                            <i data-lucide="droplets" class="me-2"></i>
                            Humidité moyenne
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance par rucher -->
        <div class="ruchers-performance">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="map-pin" class="me-2"></i>
                        Performance par rucher
                    </h3>
                </div>
                <div class="performance-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rucher</th>
                                <th>Nb. ruches</th>
                                <th>Production estimée</th>
                                <th>Temp. moyenne</th>
                                <th>Humidité moyenne</th>
                                <th>Alertes</th>
                                <th>Score santé</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="rucher : ${performanceRuchers}">
                                <td>
                                    <strong th:text="${rucher.nom}">Rucher Principal</strong>
                                    <br>
                                    <small class="text-muted" th:text="${rucher.ville}">Lyon</small>
                                </td>
                                <td th:text="${rucher.nombreRuches}">5</td>
                                <td>
                                    <span th:text="${rucher.productionEstimee + ' kg'}">45 kg</span>
                                    <small class="text-muted d-block" th:text="'(' + rucher.productionParRuche + ' kg/ruche)'">
                                        (9 kg/ruche)
                                    </small>
                                </td>
                                <td th:text="${rucher.temperatureMoyenne + '°C'}">24.5°C</td>
                                <td th:text="${rucher.humiditeMoyenne + '%'}">65%</td>
                                <td>
                                    <span th:if="${rucher.nombreAlertes > 0}" 
                                          class="badge badge-warning" 
                                          th:text="${rucher.nombreAlertes}">2</span>
                                    <span th:unless="${rucher.nombreAlertes > 0}" 
                                          class="badge badge-success">0</span>
                                </td>
                                <td>
                                    <div class="score-container">
                                        <span class="score-value" 
                                              th:text="${rucher.scoreSante + '/10'}"
                                              th:classappend="${rucher.scoreSante >= 8 ? 'text-green-600' : 
                                                             rucher.scoreSante >= 6 ? 'text-yellow-600' : 'text-red-600'}">
                                            8.5/10
                                        </span>
                                        <div class="score-bar">
                                            <div class="score-fill" 
                                                 th:style="'width: ' + (rucher.scoreSante * 10) + '%'"
                                                 th:classappend="${rucher.scoreSante >= 8 ? 'bg-green-500' : 
                                                                 rucher.scoreSante >= 6 ? 'bg-yellow-500' : 'bg-red-500'}">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top ruches et analyses -->
        <div class="analysis-section">
            <div class="row">
                <!-- Top ruches performantes -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="trophy" class="me-2"></i>
                                Top ruches performantes
                            </h3>
                        </div>
                        <div class="top-ruches">
                            <div th:each="ruche, iterStat : ${topRuches}" class="top-ruche-item">
                                <div class="rank">
                                    <span th:text="${iterStat.index + 1}">#1</span>
                                </div>
                                <div class="ruche-info">
                                    <h4 th:text="${ruche.nom}">Ruche A1</h4>
                                    <p class="text-muted" th:text="${ruche.rucherNom}">Rucher Principal</p>
                                </div>
                                <div class="ruche-metrics">
                                    <div class="metric">
                                        <span class="metric-value" th:text="${ruche.production + ' kg'}">12.5 kg</span>
                                        <span class="metric-label">Production</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-value" th:text="${ruche.scorePerformance + '/10'}">9.2/10</span>
                                        <span class="metric-label">Score</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alertes fréquentes -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="alert-triangle" class="me-2"></i>
                                Types d'alertes fréquentes
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="alertesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommandations -->
        <div class="recommendations-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="lightbulb" class="me-2"></i>
                        Recommandations et insights
                    </h3>
                </div>
                <div class="recommendations-grid">
                    <div class="recommendation-item positive">
                        <div class="recommendation-icon">
                            <i data-lucide="trending-up"></i>
                        </div>
                        <div class="recommendation-content">
                            <h4>Excellente performance</h4>
                            <p>Vos ruches du Rucher Principal montrent une production supérieure de 15% à la moyenne régionale.</p>
                        </div>
                    </div>

                    <div class="recommendation-item warning">
                        <div class="recommendation-icon">
                            <i data-lucide="thermometer"></i>
                        </div>
                        <div class="recommendation-content">
                            <h4>Surveillance température</h4>
                            <p>3 ruches ont dépassé 35°C cette semaine. Vérifiez la ventilation et l'ombrage.</p>
                        </div>
                    </div>

                    <div class="recommendation-item info">
                        <div class="recommendation-icon">
                            <i data-lucide="calendar"></i>
                        </div>
                        <div class="recommendation-content">
                            <h4>Maintenance préventive</h4>
                            <p>Il est temps de planifier l'inspection annuelle pour 4 ruches installées il y a plus d'un an.</p>
                        </div>
                    </div>

                    <div class="recommendation-item neutral">
                        <div class="recommendation-icon">
                            <i data-lucide="droplets"></i>
                        </div>
                        <div class="recommendation-content">
                            <h4>Gestion humidité</h4>
                            <p>L'humidité moyenne est optimale (65%). Maintenez les bonnes pratiques actuelles.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparaisons régionales -->
        <div class="regional-comparison">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="map" class="me-2"></i>
                        Comparaison régionale
                    </h3>
                    <small class="text-muted">Données anonymisées de la région Auvergne-Rhône-Alpes</small>
                </div>
                <div class="comparison-metrics">
                    <div class="comparison-item">
                        <div class="comparison-header">
                            <h4>Production moyenne par ruche</h4>
                        </div>
                        <div class="comparison-bars">
                            <div class="bar-container">
                                <div class="bar-label">Vous</div>
                                <div class="progress-bar">
                                    <div class="progress-fill your-data" style="width: 85%"></div>
                                </div>
                                <div class="bar-value">10.4 kg</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar-label">Moyenne régionale</div>
                                <div class="progress-bar">
                                    <div class="progress-fill regional-data" style="width: 70%"></div>
                                </div>
                                <div class="bar-value">8.6 kg</div>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-item">
                        <div class="comparison-header">
                            <h4>Taux de disponibilité</h4>
                        </div>
                        <div class="comparison-bars">
                            <div class="bar-container">
                                <div class="bar-label">Vous</div>
                                <div class="progress-bar">
                                    <div class="progress-fill your-data" style="width: 98%"></div>
                                </div>
                                <div class="bar-value">98.2%</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar-label">Moyenne régionale</div>
                                <div class="progress-bar">
                                    <div class="progress-fill regional-data" style="width: 92%"></div>
                                </div>
                                <div class="bar-value">92.1%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Styles spécifiques aux statistiques -->
    <th:block layout:fragment="styles">
        <style>
            .statistiques-container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .page-header {
                margin-bottom: 2rem;
            }

            .header-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .header-actions {
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 1.5rem;
                color: #1e293b;
            }

            .overview-section {
                margin-bottom: 3rem;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card.highlight {
                border: 2px solid var(--primary-amber-200);
                background: var(--primary-amber-50);
            }

            .stat-trend {
                margin-top: 0.5rem;
            }

            .trend-indicator {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .trend-indicator.positive {
                color: #10b981;
            }

            .trend-indicator.negative {
                color: #ef4444;
            }

            .charts-section {
                margin-bottom: 3rem;
            }

            .charts-grid {
                display: grid;
                grid-template-columns: 2fr 1fr 1fr;
                gap: 1.5rem;
            }

            .chart-card {
                background: white;
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: var(--shadow-primary);
            }

            .chart-card.large {
                grid-row: span 2;
            }

            .chart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }

            .chart-container {
                position: relative;
                height: 300px;
            }

            .chart-card.large .chart-container {
                height: 400px;
            }

            .ruchers-performance {
                margin-bottom: 3rem;
            }

            .performance-table {
                overflow-x: auto;
            }

            .score-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .score-value {
                font-weight: 600;
                min-width: 3rem;
            }

            .score-bar {
                flex: 1;
                height: 0.5rem;
                background: #e2e8f0;
                border-radius: 0.25rem;
                overflow: hidden;
            }

            .score-fill {
                height: 100%;
                transition: width 0.3s ease;
            }

            .analysis-section {
                margin-bottom: 3rem;
            }

            .top-ruches {
                max-height: 400px;
                overflow-y: auto;
            }

            .top-ruche-item {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                border-bottom: 1px solid #e2e8f0;
            }

            .rank {
                width: 2rem;
                height: 2rem;
                border-radius: 50%;
                background: var(--primary-amber-500);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 0.875rem;
            }

            .ruche-info {
                flex: 1;
            }

            .ruche-info h4 {
                margin: 0 0 0.25rem 0;
                font-size: 1rem;
                font-weight: 600;
            }

            .ruche-metrics {
                display: flex;
                gap: 1rem;
            }

            .metric {
                text-align: center;
            }

            .metric-value {
                display: block;
                font-weight: 600;
                color: #1e293b;
            }

            .metric-label {
                font-size: 0.75rem;
                color: #64748b;
                text-transform: uppercase;
            }

            .recommendations-section {
                margin-bottom: 3rem;
            }

            .recommendations-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
            }

            .recommendation-item {
                display: flex;
                align-items: flex-start;
                gap: 1rem;
                padding: 1.5rem;
                border-radius: 0.5rem;
                border-left: 4px solid;
            }

            .recommendation-item.positive {
                background: #f0fdf4;
                border-left-color: #10b981;
            }

            .recommendation-item.warning {
                background: #fffbeb;
                border-left-color: #f59e0b;
            }

            .recommendation-item.info {
                background: #eff6ff;
                border-left-color: #3b82f6;
            }

            .recommendation-item.neutral {
                background: #f8fafc;
                border-left-color: #64748b;
            }

            .recommendation-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .recommendation-content h4 {
                margin: 0 0 0.5rem 0;
                font-size: 1rem;
                font-weight: 600;
            }

            .recommendation-content p {
                margin: 0;
                color: #64748b;
                font-size: 0.875rem;
            }

            .regional-comparison {
                margin-bottom: 3rem;
            }

            .comparison-metrics {
                display: grid;
                gap: 2rem;
            }

            .comparison-item {
                padding: 1rem 0;
            }

            .comparison-header h4 {
                margin: 0 0 1rem 0;
                font-size: 1.1rem;
                font-weight: 600;
            }

            .comparison-bars {
                display: grid;
                gap: 1rem;
            }

            .bar-container {
                display: grid;
                grid-template-columns: 150px 1fr auto;
                align-items: center;
                gap: 1rem;
            }

            .bar-label {
                font-weight: 500;
                color: #1e293b;
            }

            .progress-bar {
                height: 1.5rem;
                background: #e2e8f0;
                border-radius: 0.75rem;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                transition: width 0.5s ease;
            }

            .progress-fill.your-data {
                background: var(--primary-amber-500);
            }

            .progress-fill.regional-data {
                background: #94a3b8;
            }

            .bar-value {
                font-weight: 600;
                color: #1e293b;
                min-width: 4rem;
                text-align: right;
            }

            @media (max-width: 768px) {
                .header-content {
                    flex-direction: column;
                    gap: 1rem;
                    align-items: stretch;
                }

                .charts-grid {
                    grid-template-columns: 1fr;
                }

                .chart-card.large {
                    grid-row: span 1;
                }

                .stats-grid {
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                }

                .recommendations-grid {
                    grid-template-columns: 1fr;
                }

                .bar-container {
                    grid-template-columns: 1fr;
                    gap: 0.5rem;
                }

                .bar-value {
                    text-align: left;
                }
            }
        </style>
    </th:block>

    <!-- Scripts spécifiques aux statistiques -->
    <th:block layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                if (typeof Chart !== 'undefined') {
                    initializeCharts();
                }
            });

            function initializeCharts() {
                createProductionChart();
                createTemperatureChart();
                createHumidityChart();
                createAlertesChart();
            }

            function createProductionChart() {
                const ctx = document.getElementById('productionChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
                            datasets: [{
                                label: 'Production 2024 (kg)',
                                data: [2, 3, 5, 8, 15, 25, 35, 30, 20, 12, 6, 3],
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.1,
                                fill: true
                            }, {
                                label: 'Production 2023 (kg)',
                                data: [1, 2, 4, 6, 12, 20, 28, 25, 18, 10, 5, 2],
                                borderColor: '#94a3b8',
                                backgroundColor: 'rgba(148, 163, 184, 0.1)',
                                tension: 0.1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Production (kg)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }
            }

            function createTemperatureChart() {
                const ctx = document.getElementById('temperatureChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                            datasets: [{
                                label: 'Température moyenne (°C)',
                                data: [22.5, 24.8, 26.2, 23.9],
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    min: 20,
                                    max: 30,
                                    title: {
                                        display: true,
                                        text: 'Température (°C)'
                                    }
                                }
                            }
                        }
                    });
                }
            }

            function createHumidityChart() {
                const ctx = document.getElementById('humidityChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                            datasets: [{
                                label: 'Humidité moyenne (%)',
                                data: [62, 68, 65, 70],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    min: 50,
                                    max: 80,
                                    title: {
                                        display: true,
                                        text: 'Humidité (%)'
                                    }
                                }
                            }
                        }
                    });
                }
            }

            function createAlertesChart() {
                const ctx = document.getElementById('alertesChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Température', 'Humidité', 'Poids', 'Activité', 'Connexion'],
                            datasets: [{
                                data: [35, 20, 15, 20, 10],
                                backgroundColor: [
                                    '#ef4444',
                                    '#3b82f6',
                                    '#10b981',
                                    '#8b5cf6',
                                    '#f59e0b'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }

            function exporterRapport() {
                const periode = document.getElementById('periodSelector').value;
                window.open(`/api/statistiques/export?periode=${periode}`, '_blank');
            }

            // Gérer le changement de période
            document.getElementById('periodSelector').addEventListener('change', function(e) {
                const periode = e.target.value;
                // Recharger les données avec la nouvelle période
                chargerDonneesPeriode(periode);
            });

            function chargerDonneesPeriode(periode) {
                // Simuler le rechargement des données
                console.log('Chargement des données pour la période:', periode);
                // Ici vous pourriez faire un appel AJAX pour recharger les données
            }

            // Gérer les contrôles des graphiques de production
            document.querySelectorAll('[data-period]').forEach(button => {
                button.addEventListener('click', function() {
                    // Retirer la classe active de tous les boutons
                    document.querySelectorAll('[data-period]').forEach(btn => btn.classList.remove('active'));
                    // Ajouter la classe active au bouton cliqué
                    this.classList.add('active');
                    
                    const period = this.getAttribute('data-period');
                    // Mettre à jour le graphique de production selon la période
                    updateProductionChart(period);
                });
            });

            function updateProductionChart(period) {
                // Logique pour mettre à jour le graphique selon la période
                console.log('Mise à jour du graphique de production pour:', period);
            }
        </script>
    </th:block>
</body>
</html> 