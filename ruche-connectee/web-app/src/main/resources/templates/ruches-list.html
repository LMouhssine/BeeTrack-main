<!DOCTYPE html>
<html lang="fr" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Mes Ruches - BeeTrack</title>
</head>

<body>
    <div layout:fragment="content" class="content-body">
        <!-- Page Header -->
        <div class="page-header mb-8">
            <div>
                <h1 class="page-title">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                        <polyline points="2,17 12,22 22,17"/>
                        <polyline points="2,12 12,17 22,12"/>
                    </svg>
                    Mes Ruches
                </h1>
                <p class="page-subtitle">Surveillez et gérez vos ruches connectées</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-secondary" onclick="location.reload()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23,4 23,10 17,10"/>
                        <polyline points="1,20 1,14 7,14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64l1.27 1.27m4.27 12.22l1.27 1.27A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Actualiser
                </button>
                <a href="/ruches/nouvelle" th:href="@{/ruches/nouvelle}" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nouvelle ruche
                </a>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-3 mb-8">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" th:text="${totalRuches ?: 0}">0</div>
                        <div class="stat-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                <polyline points="2,17 12,22 22,17"/>
                                <polyline points="2,12 12,17 22,12"/>
                            </svg>
                            Total
                        </div>
                    </div>
                    <div class="stat-icon bg-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                            <polyline points="2,17 12,22 22,17"/>
                            <polyline points="2,12 12,17 22,12"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value text-success" th:text="${ruchesActives ?: 0}">0</div>
                        <div class="stat-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                            Actives
                        </div>
                    </div>
                    <div class="stat-icon bg-success">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20,6 9,17 4,12"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value text-error" th:text="${alertesRuches ?: 0}">0</div>
                        <div class="stat-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            Alertes
                        </div>
                    </div>
                    <div class="stat-icon bg-error">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-6">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"/>
                    </svg>
                    Filtres
                </h2>
            </div>
            <div class="card-body">
                <div class="filters-row">
                    <div class="form-group">
                        <label for="searchRuches" class="form-label">Rechercher</label>
                        <div class="search-input-group">
                            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            <input type="text" 
                                   id="searchRuches" 
                                   class="form-control" 
                                   placeholder="Nom de ruche, rucher..."
                                   autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterStatut" class="form-label">Statut</label>
                        <select id="filterStatut" class="form-control">
                            <option value="">Tous</option>
                            <option value="actif">Actives</option>
                            <option value="inactif">Inactives</option>
                            <option value="alerte">Avec alertes</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterRucher" class="form-label">Rucher</label>
                        <select id="filterRucher" class="form-control">
                            <option value="">Tous</option>
                            <option th:each="rucher : ${ruchers}" 
                                    th:value="${rucher.nom}" 
                                    th:text="${rucher.nom}">Rucher</option>
                        </select>
                    </div>
                    
                    <div style="align-self: end;">
                        <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Effacer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ruches Grid -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                        <polyline points="2,17 12,22 22,17"/>
                        <polyline points="2,12 12,17 22,12"/>
                    </svg>
                    Liste des ruches
                    <span class="text-sm font-normal text-gray-500" th:text="'(' + ${totalRuches ?: 0} + ')'">
                        (0)
                    </span>
                </h2>
            </div>
            
            <div class="card-body">
                <!-- Empty State -->
                <div th:if="${ruches == null || #lists.isEmpty(ruches)}" class="empty-state">
                    <div class="empty-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                            <polyline points="2,17 12,22 22,17"/>
                            <polyline points="2,12 12,17 22,12"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Aucune ruche trouvée</h3>
                    <p class="empty-description">
                        Commencez par ajouter votre première ruche pour surveiller vos colonies d'abeilles.
                    </p>
                    <a href="/ruches/nouvelle" th:href="@{/ruches/nouvelle}" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Ajouter une ruche
                    </a>
                </div>

                <!-- Ruches Grid -->
                <div th:if="${ruches != null && !#lists.isEmpty(ruches)}" class="ruches-grid">
                    <div th:each="ruche : ${ruches}" 
                         class="ruche-card fade-in"
                         th:data-ruche-id="${ruche.id}"
                         th:data-ruche-nom="${ruche.nom}"
                         th:data-ruche-statut="${ruche.actif ? 'actif' : 'inactif'}"
                         th:data-ruche-rucher="${ruche.rucher?.nom ?: 'N/A'}">
                        
                        <!-- Card Header -->
                        <div class="ruche-header">
                            <div class="flex items-center gap-2">
                                <div th:if="${ruche.actif}" class="ruche-status"></div>
                                <div th:unless="${ruche.actif}" class="ruche-status inactive"></div>
                                <span class="text-sm text-gray-500">ID: <span th:text="${ruche.id}">001</span></span>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-icon" type="button" onclick="toggleDropdown(this)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="1"/>
                                        <circle cx="12" cy="5" r="1"/>
                                        <circle cx="19" cy="12" r="1"/>
                                    </svg>
                                </button>
                                <div class="dropdown-menu" style="display: none;">
                                    <a class="dropdown-item" th:href="@{/ruches/{id}(id=${ruche.id})}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        Voir détails
                                    </a>
                                    <a class="dropdown-item" href="#" onclick="refreshRuche(this.closest('.ruche-card').dataset.rucheId)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23,4 23,10 17,10"/>
                                            <polyline points="1,20 1,14 7,14"/>
                                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64l1.27 1.27m4.27 12.22l1.27 1.27A9 9 0 0 0 20.49 15"/>
                                        </svg>
                                        Actualiser
                                    </a>
                                    <hr class="dropdown-divider">
                                    <button class="dropdown-item text-danger" 
                                            onclick="confirmDelete(this)"
                                            th:data-ruche-id="${ruche.id}"
                                            th:data-ruche-nom="${ruche.nom}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"/>
                                            <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                                        </svg>
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Card Content -->
                        <div class="ruche-content">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 bg-primary text-white rounded-lg flex items-center justify-center">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                        <polyline points="2,17 12,22 22,17"/>
                                        <polyline points="2,12 12,17 22,12"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="ruche-name" th:text="${ruche.nom}">Nom de la ruche</h3>
                                    <p class="ruche-location" th:text="${ruche.rucher?.nom ?: 'Rucher non défini'}">Rucher non défini</p>
                                </div>
                            </div>

                            <!-- Metrics -->
                            <div class="ruche-metrics">
                                <div th:if="${ruche.temperature != null}" class="metric">
                                    <div class="metric-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="metric-value" th:text="${ruche.temperature + '°C'}">24°C</div>
                                        <div class="metric-label">Température</div>
                                    </div>
                                </div>
                                
                                <div th:if="${ruche.humidite != null}" class="metric">
                                    <div class="metric-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="metric-value" th:text="${ruche.humidite + '%'}">65%</div>
                                        <div class="metric-label">Humidité</div>
                                    </div>
                                </div>
                                
                                <div th:if="${ruche.niveauBatterie != null}" class="metric">
                                    <div class="metric-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="1" y="6" width="18" height="12" rx="2" ry="2"/>
                                            <line x1="23" y1="13" x2="23" y2="11"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="metric-value" 
                                             th:text="${ruche.niveauBatterie + '%'}"
                                             th:classappend="${ruche.niveauBatterie < 20 ? 'text-error' : (ruche.niveauBatterie < 50 ? 'text-warning' : 'text-success')}">85%</div>
                                        <div class="metric-label">Batterie</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                                <div>
                                    <div th:if="${ruche.actif}" class="badge badge-success">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20,6 9,17 4,12"/>
                                        </svg>
                                        Active
                                    </div>
                                    <div th:unless="${ruche.actif}" class="badge badge-secondary">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="15" y1="9" x2="9" y2="15"/>
                                            <line x1="9" y1="9" x2="15" y2="15"/>
                                        </svg>
                                        Inactive
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12,6 12,12 16,14"/>
                                    </svg>
                                    <span th:text="${ruche.derniereMAJ != null ? #temporals.format(ruche.derniereMAJ, 'HH:mm') : 'N/A'}">14:30</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h5 class="modal-title text-error">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Confirmer la suppression
                </h5>
                <button type="button" class="btn-close" onclick="closeModal()">×</button>
            </div>
            
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer la ruche <strong id="rucheNomSuppression"></strong> ?</p>
                <div class="alert alert-warning">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Cette action est irréversible. Toutes les données historiques seront perdues.
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <form id="formSuppressionRuche" method="post" style="display: inline;">
                    <button type="submit" class="btn" style="background: var(--error); color: var(--white);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"/>
                            <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                        </svg>
                        Supprimer définitivement
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Filter functionality
        function filterRuches() {
            const searchTerm = document.getElementById('searchRuches').value.toLowerCase();
            const statutFilter = document.getElementById('filterStatut').value;
            const rucherFilter = document.getElementById('filterRucher').value;
            const rucheCards = document.querySelectorAll('.ruche-card');
            
            rucheCards.forEach(card => {
                const nom = card.dataset.rucheNom.toLowerCase();
                const statut = card.dataset.rucheStatut;
                const rucher = card.dataset.rucheRucher;
                
                let visible = true;
                
                if (searchTerm && !nom.includes(searchTerm) && !rucher.toLowerCase().includes(searchTerm)) {
                    visible = false;
                }
                
                if (statutFilter && statutFilter !== statut) {
                    visible = false;
                }
                
                if (rucherFilter && rucherFilter !== rucher) {
                    visible = false;
                }
                
                card.style.display = visible ? 'block' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('searchRuches').value = '';
            document.getElementById('filterStatut').value = '';
            document.getElementById('filterRucher').value = '';
            
            document.querySelectorAll('.ruche-card').forEach(card => {
                card.style.display = 'block';
            });
        }

        // Dropdown functionality
        function toggleDropdown(button) {
            const dropdown = button.nextElementSibling;
            const isVisible = dropdown.style.display === 'block';
            
            // Close all dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Toggle current dropdown
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        // Modal functionality
        function confirmDelete(button) {
            const rucheId = button.getAttribute('data-ruche-id');
            const rucheNom = button.getAttribute('data-ruche-nom');
            
            document.getElementById('rucheNomSuppression').textContent = rucheNom;
            document.getElementById('formSuppressionRuche').action = `/ruches/${rucheId}/supprimer`;
            
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        function refreshRuche(rucheId) {
            console.log('Refreshing ruche:', rucheId);
            // Implement refresh logic
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchRuches').addEventListener('input', filterRuches);
            document.getElementById('filterStatut').addEventListener('change', filterRuches);
            document.getElementById('filterRucher').addEventListener('change', filterRuches);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }
            });

            // Close modal when clicking outside
            document.getElementById('deleteModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>