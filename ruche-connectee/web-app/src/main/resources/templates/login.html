<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - BeeTrack</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="icon" type="image/svg+xml" th:href="@{/logo.svg}">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <h1 class="login-title">BeeTrack</h1>
                <p class="login-subtitle">üî• Connexion Firebase</p>
            </div>
            
            <!-- Messages -->
            <div id="message" class="alert" style="display: none;">
                <span id="message-text"></span>
            </div>
            
            <!-- Formulaire simplifi√© -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           class="form-control" 
                           placeholder="votre@email.com"
                           required 
                           autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Mot de passe</label>
                    <input type="password" 
                           id="password" 
                           name="password" 
                           class="form-control" 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           required 
                           autocomplete="current-password">
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%;">
                    <span id="loginText">Se connecter</span>
                    <span id="loadingText" style="display: none;">‚è≥ Connexion...</span>
                </button>
            </form>
            
            <div class="login-footer">
                <div class="text-center text-muted" style="font-size: 0.875rem; margin-top: 1rem;">
                    ‚úÖ Firebase configur√© et actif
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loadingText = document.getElementById('loadingText');
            const message = document.getElementById('message');
            const messageText = document.getElementById('message-text');
            
            // Focus sur l'email
            emailInput.focus();
            
            // Fonction pour afficher un message
            function showMessage(text, type = 'info') {
                message.className = `alert alert-${type}`;
                messageText.textContent = text;
                message.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 3000);
                }
            }
            
            // Gestion du formulaire
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                
                if (!email || !password) {
                    showMessage('Veuillez remplir tous les champs', 'danger');
                    return;
                }
                
                // Afficher le chargement
                loginBtn.disabled = true;
                loginText.style.display = 'none';
                loadingText.style.display = 'inline';
                message.style.display = 'none';
                
                // Appel √† l'API Firebase
                fetch('/api/firebase-auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        email: email,
                        password: password
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showMessage('‚úÖ Connexion r√©ussie ! Redirection...', 'success');
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1500);
                    } else {
                        showMessage('‚ùå ' + (result.message || 'Erreur de connexion'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showMessage('‚ùå Erreur de connexion au serveur', 'danger');
                })
                .finally(() => {
                    // Cacher le chargement
                    loginBtn.disabled = false;
                    loginText.style.display = 'inline';
                    loadingText.style.display = 'none';
                });
            });
            
            // Test rapide de la configuration au chargement
            fetch('/api/firebase-test')
                .then(response => response.json())
                .then(result => {
                    if (result.overallStatus === 'CONNECTED') {
                        console.log('‚úÖ Firebase configur√© correctement');
                    } else {
                        console.warn('‚ö†Ô∏è Firebase partiellement configur√©:', result);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur de test Firebase:', error);
                });
        });
    </script>
</body>
</html>